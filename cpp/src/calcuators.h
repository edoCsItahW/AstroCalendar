// Copyright (c) 2025. All rights reserved.
// This source code is licensed under the CC BY-NC-SA
// (Creative Commons Attribution-NonCommercial-NoDerivatives) License, By Xiao Songtao.
// This software is protected by copyright law. Reproduction, distribution, or use for commercial
// purposes is prohibited without the author's permission. If you have any questions or require
// permission, please contact the author: 2207150234@st.sziit.edu.cn

/**
 * @file calcuators.h
 * @author edocsitahw
 * @version 1.1
 * @date 2025/07/23 17:18
 * @brief
 * @copyright CC BY-NC-SA 2025. All rights reserved.
 * */
#ifndef CALCUATORS_H
#define CALCUATORS_H
#pragma once

#include <cmath>

/**
 * @page 月球近地点进动修正原理
 *
 * @tableofcontents{nested:2}
 *
 * 月球近地点进动修正主要是为了**修正理论模型预测的月球近地点位置与实际观测位置之间的偏差**。
 *
 * 简单来说，它修正的是理论计算中未能完全考虑到的、导致月球椭圆轨道长轴（拱线）在空间中缓慢旋转的物理效应。
 *
 * @section 什么是月球近地点进动？
 * - 月球绕地球运行的轨道不是一个完美的圆形，而是一个椭圆。
 * - **近地点**是月球轨道上距离地球最近的那个点。
 * - **进动**指的是月球轨道的长轴（连接近地点和远地点的直线，也称为**拱线**）并不是固定不动的，而是在月球轨道平面内非常缓慢地旋转。
 * - 这个旋转的方向与月球公转方向相同（即顺行）。完成一圈完整的旋转大约需要 **8.85 年**（3232.6 天）。这意味着月球的近地点（和远地点）每年在轨道上向前移动大约 40.7 度。
 *
 * @section 进动产生的原因（需要修正的根源）
 * 月球近地点进动主要是由其他天体（主要是太阳）对地月系统的引力扰动（**摄动**）以及地球本身并非完美的球体（**地球扁率**）造成的：
 * - **太阳引力摄动：** 太阳的巨大引力对地月系统施加了不均匀的力。这种“第三体引力”会拉扯月球的轨道，使其形状和方向发生微小的、周期性的变化，其中就包括拱线的长期进动。
 * - **地球扁率（地球赤道隆起）：** 地球并非完美的球体，它在赤道附近略微隆起。这个隆起的额外质量对月球产生额外的引力作用。由于月球轨道相对于地球赤道面有大约 5
 * 度的倾角，这个隆起产生的引力会施加一个扭矩，导致月球的轨道平面和拱线都发生进动。**地球扁率是导致近地点进动最主要的因素（贡献约 2/3）。**
 * - **其他行星的微弱摄动：** 其他行星（尤其是金星和木星）的引力虽然很微弱，但也对月球轨道有微小的摄动作用，贡献了一小部分进动。
 *
 * @section 为什么要进行“近地点进动修正”？
 * - **理论模型的不完美：**
 * 最基础的开普勒轨道模型（只考虑地球和月球作为质点）或者只考虑主要摄动源的简化模型，无法精确预测月球在长时间尺度上的位置，特别是近地点的位置。理论计算得出的近地点位置会逐渐偏离实际天文观测到的位置。
 * - **累积偏差：** 由于进动是一个长期、持续的效应（虽然每天的变化很小），如果不加以修正，理论预测的位置误差会随着时间不断累积，变得越来越大。
 * - **精确预测的需求：**
 * 无论是为了科学研究（如引力理论验证、地球物理研究）、精确的历书编制、潮汐预报，还是现代的空间任务（如登月、月球探测器轨道设计），都需要对月球的位置（包括其近地点和远地点）进行极高精度的预测。
 *
 * @section 修正的内容
 * “近地点进动修正”就是在**复杂的月球运动理论模型或数值积分模型中**，通过以下方式将上述物理效应准确包含进去：
 * - **包含精确的摄动项：** 在描述月球运动的数学方程（如月球运动理论）中，显式地加入由太阳引力、地球扁率和其他行星引力产生的摄动项（摄动函数）。
 * - **调整轨道参数：** 在数值积分模型或轨道拟合过程中，将拱线进动率（约 40.7°/年）作为一个关键的轨道根数的长期变化率（即近地点幅角的长期变化率）来考虑和求解。
 * - **与观测拟合：** 利用长期的天文观测数据（如激光测距LLR）来精确测定实际的进动率和其他轨道参数，并用这些精确值来校正或约束理论模型。
 *
 * @section 总结
 *
 * 月球近地点进动修正，修正的是**纯二体问题或简化模型预测的月球近地点位置与实际观测之间的偏差**。这种偏差的根源是**太阳引力摄动、地球赤道隆起（扁率）以及其他行星的微弱摄动**导致的月球轨道拱线（长轴）在空间中的长期旋转（进动）。通过将这些物理效应精确地纳入复杂的月球运动理论模型或数值模型中，并利用观测数据进行校准，才能实现对月球近地点（以及整体位置）的高精度预测。这对于科学研究、历书编制、潮汐预报和深空探测都至关重要。
 * */

/**
 * @page 光行差与光行差修正
 *
 * @tableofcontents{nested:2}
 *
 * 光行差（Aberration of
 * Light）是天文观测中由于**观测者运动速度与光速的有限性**共同导致的一种视位移现象。简单来说，它使得天体看起来的位置与其真实位置之间存在一个微小偏移。这种效应在精密天文观测、导航、空间探测等领域必须进行修正。
 *
 * @section 光行差是什么？
 * 想象你在雨中奔跑：虽然雨滴垂直落下，但你会感觉雨滴是从前方倾斜打来的——这是因为你的运动速度与雨滴下落速度合成的结果。
 *
 * 类似地：
 * 1. **光速有限**（c ≈ 30万公里/秒）
 * 2. **观测者在运动**（例如地球公转速度约30 km/s）
 * 当你在运动时观测天体，光线的传播方向会因你的运动而显得偏移。这种偏移就是**光行差**。
 *
 * - **经典比喻**：
 *   - 望远镜如同一个垂直的管子，若静止时星光从管顶直射到底部。
 *   - 若望远镜随地球运动，为了接收到同一束光，必须将管子略微倾斜（指向光源的“视方向”）。
 *
 * @section 光行差的类型
 * | **类型**         | **成因**                     | **偏移量**             | **典型例子**               |
 * |------------------|------------------------------|----------------------|--------------------------|
 * | **周年光行差**   | 地球公转（约30 km/s）        | **最大20.5角秒**     | 恒星位置季节性微小摆动     |
 * | **周日光行差**   | 地球自转（赤道约0.5 km/s）   | 约0.3角秒            | 高精度测地观测            |
 * | **长期光行差**   | 太阳系在银河系中运动         | 可忽略（微角秒级）    | 银河系尺度观测            |
 * | **行星际光行差** | 探测器自身运动（如深空探测） | 需实时计算修正        | 火星探测器定位            |
 *
 * > **注**：1角秒 = 1/3600度（相当于500米外一根头发丝的宽度）
 *
 * @section 为什么要修正光行差？
 * 不修正光行差会导致**系统性误差**，影响观测精度：
 * 1. **天体定位失准**：
 *    - 恒星位置最大偏移达20.5角秒（约等于满月直径的1/90）。
 *    - 对高精度星表（如依巴谷卫星）而言，0.001角秒误差都不可接受。
 * 2. **导航偏差**：
 *    - 航天器依赖恒星确定自身位置，未修正光行差可能导致轨道偏差（如火星着陆误差达公里级）。
 * 3. **物理测量失真**：
 *    - 影响恒星视向速度、自行运动、双星轨道参数等研究。
 * 4. **相对论验证**：
 *    - 光行差是狭义相对论的基础效应之一（如Bradley实验验证光速恒定）。
 *
 * @section 如何修正光行差？
 * 修正核心是**将观测位置从“视方向”还原到“真方向”**，需三步：
 *
 * @subsection 步骤1：计算观测者速度矢量
 * - **地球公转速度**：根据观测时间从星历表获取地球公转速度矢量（约30 km/s）。
 * - **地球自转速度**：根据观测者纬度计算（赤道处约465 m/s）。
 * - **探测器速度**：深空任务需实时读取自身速度（如旅行者号约17 km/s）。
 *
 * @subsection 步骤2：应用速度矢量修正公式
 * 光行差偏移角 \(\theta\) 由以下公式给出：
 * \[
 * \tan \theta \approx \theta \approx \frac{v_{\perp}}{c}
 * \]
 * 其中：
 * - \(v_{\perp}\) = 观测者速度在垂直视线方向的分量
 * - \(c\) = 光速
 *
 * **狭义相对论下的精确公式**：
 * \[
 * \cos \theta' = \frac{\cos \theta + \frac{v}{c}}{1 + \frac{v}{c} \cos \theta}
 * \]
 * （\(\theta\)为真方向与速度方向夹角，\(\theta'\)为视方向夹角）
 *
 * @subsection 步骤3：坐标系转换
 * 1. 将观测位置从地心坐标系转换到日心坐标系。
 * 2. 扣除地球公转/自转导致的光行差偏移。
 * 3. 对深空探测数据，还需扣除探测器自身运动的影响。
 *
 * @section 关键点总结
 * | **概念**       | **说明**                                                                 |
 * |----------------|-------------------------------------------------------------------------|
 * | **本质**        | 运动观测者因光速有限看到的“倾斜光线”                                        |
 * | **最大偏移**   | 地球公转导致20.5角秒（约1000公里外偏移1米）                                |
 * | **修正核心**   | 扣除观测者速度与光速之比引起的几何偏移                                      |
 *
 * 光行差修正是连接“我们看到的世界”与“真实宇宙”的关键桥梁——它提醒我们：即使是最纯粹的光，也因观察者的运动而戴上了一层需要被剥离的透镜。
 * */

/**
 * @brief J2000历元儒略日
 *
 * @details 2000年1月1日12时00分00秒，世界时（UT1）。值为2451545.0。
 * @invariant 常量。值为2451545.0。
 * @qualifier extern
 * */
extern const double J2000;

/**
 * @brief 塑望月长度（天）
 *
 * @remarks 朔望月（lunar month），又称“太阴月”、回归月，是月球绕地球公转相对于太阳的平均周期
 * ，即中国传统的农历月份长度，历法将完全看不到月亮的那一天定为农历初一，称之为“朔”，将看到满月的那一天称之为“望”，
 * 为阴历的每月十五（或十六），从“朔”到“望”再到“朔”为一个完整周期，平均长度为29.53059天，是月面受到阳光照射的变化周期。
 * @invariant 常量。值为29.530588853。
 * @qualifier extern
 * */
extern const double SYNODIC_MONTH;

/**
 * @brief 回归年长度（天）
 *
 * @remarks 太阳年（solar year），是由地球上观察，太阳平黄经变化360°，即太阳再回到黄道（在天球上太阳行进的轨道）上相同的点所经历的时间。
 * 相对于分点和至点，精确的时间取决于你在黄道上所选择的点：从北半球的春分点，四个基础点之一，开始的称为春分点年；对在黄道上所有的点取平均值的年称为平太阳年。
 * 岁实是中国用的太阳年，是从冬至再回到冬至所经历的时间。\n
 * 太阳年又称回归年，是以太阳为参照物，地球围绕太阳旋转一周所需要的时间，是为了区分以遥远不动的恒星为参照物的“恒星年”而提出的概念。太阳中心相继两次通过春分点所经历的时间。
 * 一太阳年是根据一个世界平均时间规定的为365天又5小时48分46秒。也称为"回归年"或"分至年"。因固体潮汐导致的地球差异旋转之故，每个太阳年时间都不相等。
 * 如；公元2028年365日5时37分28秒、公元1997年365日6时1分16秒。平均为365日5时49分22秒±11分54秒。太阳年就是回归年，回归年是历法（编撰万年历）年，其时间长度是根据太阳系运行规律而提前计算出24节气点的地球表面真太阳时。
 *
 * @invariant 常量。值为365.24219878。
 * @qualifier extern
 * */
extern const double TROPICAL_YEAR;

/**
 * @brief 岁差章动模型常数（IAU 2006）
 *
 * */
extern const double PRECESSION[4];

extern const double SOLAR_COEFFS[3][4];

extern const double LUNAR_COEFFS[][4];

struct DateTime {
    int year;
    int month;
    int day;
    int hour;
    int minute;
    double second;
};

struct LunarDate {
    int year;
    int month;
    int day;
    bool isLeapMonth;
};

double normalize(double angle);

double julianDay(const DateTime&);

DateTime gregorianDay(double jd);

void precessionNutation(double jd, double &dPsi, double &dEpsilon);

double solarLongitude(double jd);

double lunarLongitude(double jd);

double calculateNewMoon(double k);

double findNewMoonNear(double jd);

double winterSolstice(int year);

double solarTerm(double jd, int index);

LunarDate gregorianToLunar(const DateTime&);

#endif  // CALCUATORS_H
