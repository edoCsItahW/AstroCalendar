# 农历计算步骤

> 其它资料:
> - [天文算法](https://mooncaker816.github.io/tags/%E5%A4%A9%E6%96%87%E7%AE%97%E6%B3%95/)
> - [黄道经度的测定](https://farside.ph.utexas.edu/Books/Syntaxis/Almagest/node34.html)
> - [.NET Core计算行星位置(1)——VSOP 2013 概论](https://zhuanlan.zhihu.com/p/90756402)
> - [天文学基础（时间和历法）](https://sirlis.cn/posts/astronomy-basic-time-calender)

## 农历计算步骤概览

```mermaid
flowchart TD
    A[输入公历日期\nY年 M月 D日 H时 Min分 S秒] --> B[转换为儒略日JD]
    B --> C[ΔT修正得到地球力学时TT]
    C --> D1[计算朔望月\n新月时刻]
    C --> D2[计算24节气]
    D1 --> E[定位冬至]
    D2 --> E
    E --> F[生成朔日序列]
    F --> G[编排月份与闰月判定]
    G --> H[计算干支]
    H --> I[输出农历日期]

subgraph 儒略日转换
B[["**儒略日计算**
        入参: Y,M,D,H,Min,S
公式:
a = INT(Y/100)
B = 2 - a + INT(a/4)
JD = INT(365.25×(Y+4716))
+ INT(30.6001×(M+1))
+ D + B - 1524.5
+ (H + Min/60 + S/3600)/24
修正: 格里高利历修正项B
结果: 儒略日JD"]]
end

subgraph 地球力学时修正
C[["**ΔT修正**
入参: JD(UTC时间)
公式:
T = (JD - 2451545.0)/36525
ΔT = 32t² + 20.5 (多项式模型)
TT = JD + ΔT/86400
修正: 地球自转不均匀性ΔT
结果: 地球力学时TT"]]
end

subgraph 朔望月计算
D1[["**新月时刻计算**
入参: TT
模型: ELP/MPP02月球模型
公式:
Δλ = λ☾ - λ☉ = 0°
牛顿迭代法求解
修正:
- 月球轨道摄动(ELP周期项)
- 潮汐减速(0.00025秒/年)
结果: 精确朔时刻序列"]]
end

subgraph 节气计算
D2[["**24节气计算**
入参: TT
模型: VSOP87太阳模型
公式:
λ☉ = f(T) = 目标角度(0°,15°...345°)
牛顿迭代法求解
修正:
- 光行差(IAU2006)
- 章动修正
结果: 精确节气时刻序列"]]
end

subgraph 年框架建立
E[["**农历年框架**
入参: 朔时刻序列 + 节气序列
步骤:
1. 找到冬至(λ☉=270°)
2. 确认所属农历年
3. 确定冬月(含冬至月)
结果: 年起始点 + 月基准"]]
end

subgraph 月序编排
F[["**朔日序列生成**
入参: 冬至前朔日 + 模型
方法: 连续计算13个朔日
修正: 残差补偿(每220年补1日)
结果: 月首序列"]]

G[["**闰月判定**
入参: 月首序列 + 节气序列
规则:
1. 标记每月所含中气
2. 首个无中气月设为闰月
结果: 正常月序 + 闰月标记"]]
end

subgraph 干支计算
H[["**干支计算**
入参: JD
日干支:
序号 = (JD + 9) mod 60
天干 = 序号 mod 10
地支 = 序号 mod 12
年干支: 以立春为界
结果: 完整干支日期"]]
end

subgraph 输出
I[["**农历日期输出**
格式示例:
癸卯年 闰二月 初三日
包含:
- 农历年月日
- 闰月标志
- 干支信息
- 误差范围标注"]]
end
```

## 儒略日转换

儒略日（Julian Day，JD）表示从公元前4713年1月1日正午开始的连续天数。

由于它没有其它历法那样复杂的规则，而且只有一项数据，而其它历法通常需要年、月、日等多项数据，

最重要的是，儒略日直接表示天数，可以说是历法的本质或者共同表示。

公式:
$$
\begin{align*}
JD & = \text{floor}(365.25 \times (Y + 4716)) + \text{floor}(30.6001 \times (M + 1)) + D + B - 1524.5 + \frac{H}{24} + \frac{\text{Min}}{1440} + \frac{S}{86400} \\
B & = 2 - \text{floor}(Y/100) + \text{floor}(\text{floor}(Y/100)/4)
\end{align*}
$$

其中:

- Y: 公历年（如2023）。
- M: 公历月（1-12）。
- D: 公历日（1-31）。
- H: 时（0-23）。
- Min: 分（0-59）。
- S: 秒（0-59）。
- B: 格里高利历修正项。

## 地球力学时与修正

由于儒略日是基于协调世界时（UTC）或国际原子时（TAI）计算的，但是UTC受地球自转不均匀性（潮汐摩擦、地核运动等）影响，

从而导致UTC不是地球真正经历的时间，也因此UTC需要通过添加闰秒来进行修正。

那么UTC修正的目标正是地球力学时（Terrestrial Time，TT），它是一个更接近地球自转的时间系统，也就是更接近地球正真经历的时间。

TT与UTC的关系可以通过$\Delta T$来表示。

其严格表示:
$$
\begin{align*}
\Delta T & = TT - UTC \\
\Delta T & = 32.184 + \Delta AT + DUT1
\end{align*}
$$

其中:

- 32.184秒是TT与TAI（Temps Atomique International. 原子时）的固定差值，属于历史遗留偏移。
- $\Delta AT$: 阶梯变化，是闰秒积累的结果。也等于TAI - UTC。
- DUT1: 地球自转短期变化的修正，通常在-0.9到+0.9秒之间。

为了说明各时间复杂的关系，参考下图
![时间系统关系图](https://pic3.zhimg.com/v2-9888d1b4327082abc296d9c281aec774_1440w.jpg)

但是在实际计算中，我们一般不直接使用$\Delta T$的复杂公式，而是数学模型来近似计算$\Delta T$。

需要提前说明的是，由于地球自转的不均匀性是不可预测也没有规律的，所以近似的$\Delta T$模型一般会对某些特定时间段进行拟合。

- 2005 - 2050（误差$\pm 1$秒）:
  $$
  \Delta T = 69.92 + 0.32217 \cdot (y - 2005) + 0.005589 \cdot (y - 2005)^2
  $$
  其中:
    - y: 年份 + (月份 - 0.5) / 12。

- 2000 - 2100（误差$\pm 5$秒）:
  $$
  \Delta T = 70.6 + 0.36 \cdot (y - 2010)
  $$
- 1800 - 2020（误差$\pm <1$秒）:
  $$
  \Delta T = -18.328 + 123.5 \cdot t + 32.5 \cdot t^2
  $$
- 1600 - 1800（误差$\pm 2$秒）:
  $$
  \Delta T = 120.3 - 98.8 \cdot t + 52.4 \cdot t^2
  $$

- NASA的五次项拟合，参见[Polynomial Expressions for Delta T (ΔT)](https://eclipse.gsfc.nasa.gov/SEcat5/deltatpoly.html)

- 长期演化模型（含潮汐减速）:
  $$
  \Delta T \approx 31 \cdot (y - 1820)^2 \quad \text{其中} (y > 1820)
  $$

> - 短期高精度：使用 Espenak 多项式（2005–2050）。
> - 历史研究：采用 van Gent 分段模型 或查表。
> - 关键资源：NASA ΔT 多项式 和 IERS EOP 数据。

## 朔望月计算

首先需要理解农历的基本概念。

----

### 农历规则

农历是一种阴阳合历，阴阳合历是指既有阴历（基于月亮的周期）又有阳历（基于太阳的周期）。

并且农历不是数学历法（仅通过数计算），而是天文学历法（需要通过天文观测数据和计算来确定）。

#### 第一步: 定气

二十四节气是农历的阳历部分，二十四节气是太阳在黄道上的位置划分。

太阳在黄道上旋转360度需要一年时间，而二十四节气则将这一年分为24个等分，每个节气对应太阳黄经的15度。

例如当直射点到达0度时为春分，90度（北回归线）为夏至，180度为秋分，270度（南回归线）为冬至。

这里需要附加说明的是，二十四节气中基数的节气叫节令（如春分、夏至、秋分、冬至），偶数的节气叫中气（如立春、立夏、立秋、立冬等）。

#### 第二步: 定朔

朔是指新月时刻，即月球和太阳的地心视黄经相等（日月合朔）的时刻。而平朔是指朔望月的平均长度，即从一个新月到下一个新月的平均时间。

> [!TIP]
> 名词解释：
> - 地心视黄经：是指从地球中心看月球和太阳的角度位置。需要考虑岁差、章动、光行差、周年视差和引力偏折等因素。
> - 日心视黄经：是指从太阳中心看月球和地球的角度位置。需要考虑岁差、章动、引力偏折和行星光行时等因素。

朔望月的平均长度约为29.530588853天（即29天12小时44分2.9秒），但实际长度会因月球轨道的摄动而有所变化。

所以，如果我们要“定朔”（而不是使用平朔），就需要计算月球和太阳的地心视黄经相等的时刻，这也是朔望月计算中的主要部分。

#### 第三步: 定月

规定农历月从朔日开始，朔日是农历月的第一天，也就是农历初一。

#### 第四步: 冬至建子

找到包含冬至的农历月（即冬至所在的朔日），称为子月。

#### 第五步: 无中置闰，闰前不闰后

如果某一个子月到下一个子月之间有13个农历月，那么就要找到没有中气的月份置为闰月。

如果不止一个没有中气的月份，则取第一个没有中气的月份作为闰月。

#### 第六步: 干支

这部分与计算无关，略

----

在了解农历的基本概念后，我们可以开始计算朔望月。

朔望月的计算需要使用天文模型来计算太阳和月球的地心视黄经。

截至2025，太阳模型最新的是VSOP2013，而月球模型最新的是LEA-046。

为了确保接下来的计算，我们先介绍一些天文和物理术语与它们之间的关系

- 进动:
    > 参考[百度百科](https://baike.baidu.com/item/%E8%BF%9B%E5%8A%A8/824030)

    这和角动量守恒有关，地球的自转轴会缓慢地围绕垂直于黄道平面的轴线旋转，这个现象称为岁差。当然，这不会很好理解，可以辅助图片理解  
    ![进动](https://baike.baidu.com/pic/%E8%BF%9B%E5%8A%A8/824030/0/279759ee3d6d55fb53dd11746f224f4a20a4dd4d#aid=0&pic=279759ee3d6d55fb53dd11746f224f4a20a4dd4d)

- 章动:
    > 参考[百度百科](https://baike.baidu.com/item/%E7%AB%A0%E5%8A%A8/695762)

    当陀螺的自转角速度不够大时，则除了自转和进动外，陀螺的对称轴还会在铅垂面内上下摆动，称为章动。  
    瞬时北天极绕瞬时平北天极旋转产生的椭圆轨迹。
    在天文学上天极相对于黄极的位置除有长周期的岁差变化外，还有许多短周期的微小变化。引起这种变化的原因是地球相对于月球和太阳的位置有周期性的变化，它所受到的来自后两者的引力作用也有相同周期的变化，使得地球自转轴的空间指向除长期的缓慢移动（岁差）外，还叠加上各种周期的幅度较小的振动，这称为章动。
    ![章动](https://baike.baidu.com/pic/%E7%AB%A0%E5%8A%A8/695762/0/d50735fae6cd7b89bbf0bb2b042442a7d8330efd#aid=0&pic=d50735fae6cd7b89bbf0bb2b042442a7d8330efd)

- 摄动:
    > 参考[百度百科](https://baike.baidu.com/item/%E6%91%84%E5%8A%A8/4777855)

    摄动指一个天体绕另一个天体按二体问题的规律运动时，因受其它天体的吸引或其他因素的影响在轨道上产生的偏差，这些作用与中心体的引力相比是很小的，因此称为摄动。天体在摄动作用下，其坐标、速度或轨道要素都产生变化，这种变化成分称为摄动项。

- 光行差:
    > 参考[百度百科](https://baike.baidu.com/item/%E5%85%89%E8%A1%8C%E5%B7%AE/490327)

  光行差（或称为天文光行差、恒星光行差）是指运动的观测者观察到光的方向与同一时间同一地点静止的观测者观察到的方向有偏差的现象。

- 周年视差:
    > 参考[百度百科](https://baike.baidu.com/item/%E5%91%A8%E5%B9%B4%E8%A7%86%E5%B7%AE/10660162)

    周年视差（annual parallax），是地球绕太阳周年运动所产生的视差。

- 黄道:
    > 参考[百度百科](https://baike.baidu.com/item/%E9%BB%84%E9%81%93/14773)

    黄道是地球绕太阳公转的轨道平面在天球上的投影，表现为太阳一年中在天空中运行的路径。

- 黄道坐标系:
    > 参考[百度百科](https://baike.baidu.com/item/%E9%BB%84%E9%81%93%E5%9D%90%E6%A0%87%E7%B3%BB/362777)

    黄道坐标系是以黄道为基圈〔相当于平面直角坐标系的横轴），以经过春分点的黄经圈（半圆）为始圈（相当于平面直角坐标系的纵轴），以春分点为原点组成的天球坐标系，它的经度叫黄经〔λ〕，是天体所在的黄经圈—终圈同始圈的角距离，即终圈与始圈所夹黄道的一段弧，以春分点为起点，在黄道上逆时针（左旋）度量，从0°到360°，它的纬度叫黄纬（β），是天体相对于黄道的方向和角距离。

- 平黄经:
    天体在**平均轨道**上的理论黄经。这是一个理论值或者说平均值，不考虑摄动和其他因素。

- 真黄经:
    天体在**真实轨道**上的瞬时黄经。这是一个实际值，但不经过观测，需要考虑摄动和其他不包括观测效应的因素。
    
    与平黄经的关系: $\lambda_{true} = \lambda_{mean} + \sum \Delta \lambda$，其中$\Delta \lambda$是各摄动项。

- 视黄经:
    从**地球观测**到的黄经。这是一个实际观测值，经过观测，不仅考虑摄动和其他因素，还需要考虑光行差、周年视差等观测效应。

    与真黄经的关系: $\lambda_{observed} = \lambda_{true} + \Delta \lambda_{axial} + \Delta \lambda_{nutation} + \Delta \lambda_{light} + \Delta \lambda_{annual}$，其中$\Delta \lambda_{arial}$是岁差，$\Delta \lambda_{nutation}$是章动，$\Delta \lambda_{light}$是光行差，$\Delta \lambda_{annual}$是周年视差。

![轨道运动图](https://i-blog.csdnimg.cn/blog_migrate/1550ae74cfdfcd4ca6ffb9b0e1de348d.png)

该图中O是地球，P是绕地球公转的月球，$O_1$是虚拟圆轨道的圆心，也是椭圆轨道的中心，其中虚拟圆的半径是椭圆的长轴长度。k是虚拟圆轨道和椭圆轨道的右交点。
在位置P作长半轴垂线，与长半轴交点为R，延长RP与虚拟圆轨道相交于点Q。

> [!TIP]
> 为什么椭圆轨道的计算需要引入虚拟圆轨道？
> - 开普勒第二定律: 中心天体与环绕天体的连线（称矢径）在相等的时间内扫过相等的面积。  
> 但是在椭圆轨道上，行星的运动速度是不均匀的（近日点最快，远日点最慢）。直接计算行星在给定时间内扫过的椭圆扇形面积非常复杂。
> 而圆轨道的运动速度是均匀的，且半径不变，那相同时间内扫过的面积是相等的。这真好符合开普勒第二定律。反过来，椭圆是不均匀的运动速度，放在圆上就是匀速的。
> 因此我们可以通过虚拟圆轨道来简化椭圆轨道的计算。

- 平近点角:
    > 参考[百度百科](https://baike.baidu.com/item/%E5%B9%B3%E8%BF%91%E7%82%B9%E8%A7%92/5984710)
  
    假设天体以**平均角速度**运动时，从近地点起算的理论角度，即图中的$\angle QOR$。

- 真近点角:
    > 参考[百度百科](https://baike.baidu.com/item/%E7%9C%9F%E8%BF%91%E7%82%B9%E8%A7%92/5908766)

    指天体从近地点起沿轨道运动时其向径扫过的角度，是某一时刻轨道近地点到卫星位置矢量R的夹角。即图中的$\angle POR$。

- 偏近点角:
    > 参考[百度百科](https://baike.baidu.com/item/%E5%81%8F%E8%BF%91%E7%82%B9%E8%A7%92/5908781)

  在轨道上的天体所在的位置投影在垂直于椭圆半长轴的外接圆上并从椭圆的中心量度和近拱点方向之间的角度。即图中的$\angle QO_1 R$。

**月球轨道偏差项**
> 参考[Wiki](https://www.wikiwand.com/zh-cn/articles/%E6%9C%88%E7%90%83%E9%81%8B%E5%8B%95%E8%AB%96)
1.  **月行差：**
    *   **含义：** 这是**所有月球轨道偏差的总称**。它不是指某一个特定的差，而是指月球实际位置与其平均（或理论计算）位置之间存在的**总偏差**。这个总偏差是所有其他“差”（如中心差、出差等）综合作用的结果。
    *   **成因：** 各种摄动力（主要是太阳引力摄动）的综合效应。

2.  **中心差：**
    *   **含义：** 这是**最大也是最重要的月球轨道偏差**。它描述了月球在其椭圆轨道上运行时，由于轨道偏心率导致的速度不均匀性（开普勒第二定律）。当月球位于近地点时，运动最快；位于远地点时，运动最慢。中心差是轨道本身特性决定的。
    *   **成因：** 月球绕地球公转轨道的**偏心率**。
    *   **周期：** 约 **27.55天** (一个近点月)。
    *   **振幅：** 最大可达约 **6.29度**。
    *   其前三项: $+22639'' \sin (l) + 769'' \sin (2 l) + 36'' \sin (3 l)$，其中l是月球的平均黄经。

3.  **出差：**
    *   **含义：** 这是**第二大**的月球轨道偏差。它主要体现为月球轨道长轴方向（拱线方向）的周期性摆动，并与月球和太阳的相对位置密切相关。出差具有明显的半月周期特征。
    *   **成因：** **太阳引力**对月球轨道的摄动，特别是对轨道拱线（近地点方向）的摄动。
    *   **周期：** 约 **14.77天** (半个朔望月)。
    *   **振幅：** 最大约 **1.27度**。
    *   主要项： $+4586'' \sin (2D - l)$，其中D是月球的平均黄纬，l是月球的平均黄经。

4.  **二均差：**
    *   **含义：** 这是对“出差”项的一个重要修正项。它的周期是出差周期的一半。
    *   **成因：** 同样是**太阳引力摄动**，是对出差项的更高阶效应或更精细描述。
    *   **周期：** 约 **7.38天** (四分之一个朔望月)。
    *   **振幅：** 比出差小，约 **0.66度**。
    *   主要项: $+2370'' \sin (2 D)$，其中D是月球的平均黄纬。

5.  **周年差：**
    *   **含义：** 描述月球运动在一年周期内的偏差。这主要是由于地球绕太阳公转轨道的偏心率导致的。当地球位于其轨道的近日点时，太阳对月球的引力摄动稍强；在远日点时稍弱。
    *   **成因：** **地球绕太阳公转轨道的偏心率**，导致日地距离变化，从而引起太阳对月球摄动强度的周年变化。
    *   **周期：** **1年** (365.25天)。
    *   **振幅：** 相对较小，约 **11角分 (0.18度)**。
    *   主要项: $-668'' \sin (l')$，其中l'是月球的平均黄经减去地球公转轨道的平均黄经。

6.  **月角差：**
    *   **含义：** 因为太阳到地球的距离并非无限远，太阳的视差并不为零，所以上述Brahe的周年差还要加上一个小小的不对称项。 它的效应是，月球公转在上弦月时略有落后，下弦月时略有超前。
    *   **成因：** **月球轨道倾角（黄白交角）** 的存在。
    *   **周期：** 约 **173天** (接近半年)。
    *   **振幅：** 黄经方向约 **0.19度**。
    *   主要项： $-125'' \sin (D)$，其中D是月球的平均黄纬。

7.  **黄白交角导致的均差：**
    *   **含义：** **月角差**就是由黄白交角引起的主要均差。。
    *   **解释：** “黄白交角导致的均差”指的就是月球轨道平面（白道）与地球公转轨道平面（黄道）之间的夹角（平均约5.15度）所引起的月球位置偏差。
    *   主要项: $-412'' \sin (2 F)$，其中F是月球的平均黄纬。

---

接下来通过月动模型LEA-406计算月球的视黄经。

1. 进行时间尺度转换：

LEA-406的计算都是基于TDB（质心力学时，太阳系质心参考系）时间，之前我们已经得到了当前时间的TT时间，所以需要进行时间转换。

$$
\begin{aligned}
TDB & = TT + \Delta T  \\
\Delta T & = 0.001658 \sin ( g + 0.0167 \sin g )  \\
g & = \frac{2 \pi (357.528^{\circ} + 35999.05^{\circ} T}{360^{\circ}}  \\
T & = \frac{JD_{TT} - 2451545}{36525}
\end{aligned}
$$
单位：秒
其中:
T: 从TT的J2000起算的儒略世纪数

我的理解是，TT这个时间尺度，其表达方式包括儒略日和通过年月日时分秒组合的时刻。

而两种方式中用于计算的数值形式就是JD，所以我认为式中的TT就是$JD_{TT}$。

那么现在我们获得了TDB时间（$JD_{TDB}$），就可以进行月球视黄经计算了。

2. 计算平黄经：

根据LEA-406的公式(37)，我们可以计算出平黄经：

$$
\bar{V}(t) = 218^{\circ}31664563 + 
173256437''2370470 \cdot t − 527''90 \cdot t^2 + 6''6655 \cdot t^3 − 0''5522 \cdot t^4
$$

系数单位：角秒

注：实际计算时，需要将角秒转化为弧度。

3. 计算周期项：

月球黄经由平黄经+周期项组成：

$$
V(t) = \bar{V}(t) + \sum_{k=1}^{N_v} \left [ A_{k0}^{(V)} \sin (\theta_k) + A_{k1}^{(V)} \sin (\theta_k) t + A_{k2}^{(V)} \sin (\theta_k) t^2 \right ]
$$

其中:

$$
\theta_k = \omega_k^{(V)} (t) + \varphi_k^{(V)}
$$

- 构造辐角$\omega_k^{(V)}$：
